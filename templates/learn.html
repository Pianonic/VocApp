{% extends "base.html" %} {% block title %}Learn: {{ deck['name'] }}{% endblock
    %} {% block content %}
    <div
      class="d-flex justify-content-between align-items-center mb-4 pb-2 border-bottom"
    >
      <h1 class="text-3xl font-semibold text-gray-800">
        Learning: {{ deck['name'] }}
      </h1>
      <a
        href="{{ url_for('view_deck', deck_id=deck['id']) }}"
        class="btn btn-outline-secondary btn-sm"
        >&laquo; Back to Deck</a
      >
    </div>
    
    <div class="row justify-content-center">
      <div class="col-md-8 col-lg-6">
        <div id="flashcard-container" class="card shadow-lg text-center">
          <div class="card-header bg-gray-200">
            <span id="progress" class="text-sm font-medium text-gray-600"
              >Word 1 of {{ total_words }}</span
            >
          </div>
          <div class="card-body p-5 min-h-[250px] flex flex-col justify-center">
            <!-- Term Area -->
            <div id="term-area">
              <h2 id="term" class="text-4xl font-bold text-blue-800 mb-4">
                Loading...
              </h2>
            </div>
    
            <!-- Answer Area (Initially Hidden) -->
            <div id="answer-area" class="hidden mt-4 text-left">
              <hr class="my-3" />
              <p id="translation" class="text-purple-700 italic text-lg mb-2"></p>
              <p id="definition" class="text-gray-800 text-lg mb-2"></p>
              <p id="example" class="text-gray-600 fst-italic text-md"></p>
            </div>
          </div>
          <div class="card-footer bg-gray-50 p-3">
            <button
              id="show-answer-btn"
              class="btn btn-primary w-1/2 me-2"
              disabled
            >
              Show Answer
            </button>
            <button
              id="next-word-btn"
              class="btn btn-success w-1/2 hidden"
              disabled
            >
              Next Word &rarr;
            </button>
          </div>
        </div>
        <div id="finished-message" class="alert alert-success mt-4 text-center hidden" role="alert">
            <strong>Congratulations!</strong> You've completed this deck session.
            <a href="{{ url_for('learn_deck', deck_id=deck['id']) }}" class="alert-link">Learn Again</a> or
            <a href="{{ url_for('view_deck', deck_id=deck['id']) }}" class="alert-link">Return to Deck</a>.
        </div>
      </div>
    </div>
    
    {% endblock %} {% block scripts %}
    <script>
      // Get data passed from Flask
      // Use '|| []' as fallback in case words_json is null/undefined
      const wordsData = JSON.parse('{{ words_json | safe or "[]" }}');
      const totalWords = JSON.parse('{{ total_words | default(0) | tojson }}');
    
      // Get DOM elements
      const termEl = document.getElementById("term");
      const translationEl = document.getElementById("translation");
      const definitionEl = document.getElementById("definition");
      const exampleEl = document.getElementById("example");
      const progressEl = document.getElementById("progress");
      const answerAreaEl = document.getElementById("answer-area");
      const showAnswerBtn = document.getElementById("show-answer-btn");
      const nextWordBtn = document.getElementById("next-word-btn");
      const flashcardContainer = document.getElementById("flashcard-container");
      const finishedMessage = document.getElementById("finished-message");
    
    
      let currentWordIndex = 0;
      let words = []; // Will hold shuffled words
    
      // Function to shuffle array (Fisher-Yates)
      function shuffleArray(array) {
          for (let i = array.length - 1; i > 0; i--) {
              const j = Math.floor(Math.random() * (i + 1));
              [array[i], array[j]] = [array[j], array[i]]; // Swap elements
          }
          return array;
      }
    
    
      function displayWord(index) {
        if (index >= words.length) {
            // Handle end of deck
            flashcardContainer.classList.add('hidden'); // Hide card
            finishedMessage.classList.remove('hidden'); // Show finished message
            return;
        }
    
        const word = words[index];
    
        // Update Term
        termEl.textContent = word.term;
    
        // Reset Answer Area
        answerAreaEl.classList.add("hidden"); // Hide answers
        translationEl.textContent = word.translation ? `[${word.translation}]` : "";
        definitionEl.textContent = word.definition;
        exampleEl.textContent = word.example ? `E.g., "${word.example}"` : "";
    
        // Hide optional fields if empty
        translationEl.style.display = word.translation ? 'block' : 'none';
        exampleEl.style.display = word.example ? 'block' : 'none';
    
    
        // Update Progress
        progressEl.textContent = `Word ${index + 1} of ${totalWords}`;
    
        // Reset Buttons
        showAnswerBtn.classList.remove("hidden");
        nextWordBtn.classList.add("hidden");
        showAnswerBtn.disabled = false; // Enable show answer button
        nextWordBtn.disabled = true; // Keep next disabled until answer shown
      }
    
      function showAnswer() {
        answerAreaEl.classList.remove("hidden"); // Show answers
        showAnswerBtn.classList.add("hidden"); // Hide show answer button
        nextWordBtn.classList.remove("hidden"); // Show next button
        nextWordBtn.disabled = false; // Enable next button
        nextWordBtn.focus(); // Focus next button for easier keyboard nav
      }
    
      function nextWord() {
        currentWordIndex++;
        displayWord(currentWordIndex);
      }
    
      // --- Initialization ---
      document.addEventListener("DOMContentLoaded", () => {
        if (totalWords > 0 && wordsData.length > 0) {
            words = shuffleArray([...wordsData]); // Shuffle a copy of the data
            displayWord(currentWordIndex); // Display the first word
    
            // Add event listeners
            showAnswerBtn.addEventListener("click", showAnswer);
            nextWordBtn.addEventListener("click", nextWord);
    
            // Optional: Keyboard navigation (Enter for Show/Next)
            document.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    if (!showAnswerBtn.classList.contains('hidden') && !showAnswerBtn.disabled) {
                        showAnswer();
                    } else if (!nextWordBtn.classList.contains('hidden') && !nextWordBtn.disabled) {
                        nextWord();
                    }
                }
            });
    
        } else {
          // Handle case where there are no words (though Flask should prevent this)
          termEl.textContent = "No words in this deck.";
          showAnswerBtn.disabled = true;
          nextWordBtn.disabled = true;
        }
      });
    </script>
    {% endblock %}
    